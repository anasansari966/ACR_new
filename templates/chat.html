<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Bot</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="chat-container">
        <h1>Chatbot Assistant</h1>
        <div class="chat-box" id="chat-box">
            <!-- Chat messages will be appended here -->
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message here...">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let extractedData = null;
        let missingFields = [];
        let isConfirmDisabled = false;  // Track if confirm button is disabled

        function sendMessage() {
            const userInput = document.getElementById('user-input').value;
            if (userInput.trim() === '') return;

            // Append user's message to chat
            appendMessage('user-message', userInput);

            // Send message to the backend
            fetch('/get-response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userInput }),
            })
            .then(response => response.json())
            .then(data => {
                // Append bot's response to chat
                appendMessage('bot-message', data.response);

                // If there's extracted data, show the preview within the chat
                if (data.preview && Object.keys(data.preview).length > 0) {
                    extractedData = data.preview;
                    const previewMessage = `
                        <strong>Preview Extracted Data:</strong><br>
                        ${formatDataPreview(extractedData)}
                        <br>
                        <button onclick="confirmData()" ${isConfirmDisabled ? 'disabled' : ''}>Confirm</button>
                        <button onclick="cancelData()">Cancel</button>
                    `;
                    appendMessage('bot-message', previewMessage);
                }
            });

            // Clear input field
            document.getElementById('user-input').value = '';
        }

        function formatDataPreview(data) {
            let formatted = '<ul>';
            for (const [key, value] of Object.entries(data)) {
                formatted += `<li><strong>${capitalizeFirstLetter(key.replace('_', ' '))}:</strong> ${value}</li>`;
            }
            formatted += '</ul>';
            return formatted;
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function appendMessage(className, message) {
            const chatBox = document.getElementById('chat-box');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${className}`;
            messageElement.innerHTML = message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;  // Scroll to the bottom
        }

        function confirmData() {
            if (isConfirmDisabled) return;

            // Disable the confirm button to prevent multiple clicks
            isConfirmDisabled = true;

            fetch('/confirm-save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ patient_data: extractedData }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    appendMessage('bot-message', data.message);
                } else if (data.status === 'missing') {
                    handleMissingFields(data.fields);
                } else {
                    appendMessage('bot-message', `Error: ${data.message}`);
                }
            });
        }

        function handleMissingFields(fields) {
            for (const field of fields) {
                appendMessage('bot-message', `Please enter the value for '${field}': <input type="text" id="${field}" placeholder="${field}"> <button onclick="submitMissingValue('${field}')">Submit</button>`);
            }
        }

        function submitMissingValue(field) {
            const value = document.getElementById(field).value;
            if (value.trim() === '') return;

            extractedData[field.replace(' ', '_')] = value;
            document.getElementById(field).parentElement.remove();  // Remove the input and button
            confirmData();  // Re-check if the data is complete
        }

        function cancelData() {
            appendMessage('bot-message', "Enter data from insert");
            extractedData = null;  // Clear extracted data
            isConfirmDisabled = false;  // Re-enable the confirm button
        }
    </script>
</body>
</html>
